#!/usr/bin/env python3

# -*- coding: utf-8 -*-
"""27453-download-ipd.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1FuxOmf46uVM9-kYeO27YBJF8AzJs2_0P
"""

# requests installed by default in google colab
# install biopython
# !pip install biopython

import sys
from Bio import SeqIO
import requests
from datetime import datetime

allele_count = int(sys.argv[1])

# create output genbank file for entire database
with open("ipd-mhc-nhp-" + datetime.today().strftime('%Y-%m-%d') + ".gbk", "a") as all_nhp:

  # create output genbank file for rhesus only
  with open("ipd-mhc-mamu-" + datetime.today().strftime('%Y-%m-%d') + ".gbk", "a") as mamu:

    # create output genbank file for cyno only
    with open("ipd-mhc-mafa-" + datetime.today().strftime('%Y-%m-%d') + ".gbk", "a") as mafa:

      # create output genbank file for mane only
      with open("ipd-mhc-mane-" + datetime.today().strftime('%Y-%m-%d') + ".gbk", "a") as mane:

        # make range of ids to download from ebi
        nhp_id = range(1, allele_count)

        # add leading zeros and nhp prefix
        # this is the EBI dbfetch format
        nhp_id = ['NHP' + str(item).zfill(5) for item in nhp_id]

        # iterate over all NHP files to retrieve
        for i in nhp_id:     
          
          print("pulling record", i, "out of", allele_count, sep=" ")
          
          # get record
          u = requests.get("https://www.ebi.ac.uk/Tools/dbfetch/dbfetch?db=ipdmhc;id=" + i + ";style=raw")

          # IPD MHC uses non-standard ID line
          # need to remove first two semicolons in ID line
          ipd_embl = u.text # read content

          # handle missing records
          # these don't have identifiers and can be skipped
          if not ipd_embl.startswith('ID'):
              continue

          ipd_line = ipd_embl.splitlines() # split by line
          id_line = ipd_line[0] # get ID line
          id_line_split = id_line.split(';') # split elements by semicolon

          # reconstruct ID line in EMBL format that can be parsed by biopython
          ipd_line[0] = id_line_split[0] + ' ' + id_line_split[1] + ' ' + id_line_split[2] + '; ' + id_line_split[3] + '; ' + id_line_split[4] + '; ' + id_line_split[5]

          # join lines to create embl file
          embl_file = ('\n').join(ipd_line)

          # create temporary file in correct EMBL format
          # i tried to use tempfile but couldn't get it to work
          with open("response.embl", "w") as f:
              f.write(embl_file)

          # read EMBL file and export as Genbank
          for record in SeqIO.parse("response.embl", "embl"):
              record.description = record.name
              
              record.name = record.annotations['keywords'][0]
              print(record.name + ' - ' + record.description)
              SeqIO.write(record, all_nhp, "genbank")

              # if rhesus sequence
              if record.name.startswith('Mamu'):
                SeqIO.write(record, mamu, "genbank")

              # if cyno sequence
              if record.name.startswith('Mafa'):
                SeqIO.write(record, mafa, "genbank")

              # if mane sequence
              if record.name.startswith('Mane'):
                SeqIO.write(record, mane, "genbank")
